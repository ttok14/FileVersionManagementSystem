# ui/widgets.py
# Ïª§Ïä§ÌÖÄ ÏúÑÏ†Ø ÌÅ¥ÎûòÏä§Îì§ - modelsÏóêÎßå ÏùòÏ°¥

from typing import List, Optional, Dict
from PySide6.QtWidgets import (
    QListWidget, QListWidgetItem, QTextEdit, QWidget, QVBoxLayout,
    QHBoxLayout, QLabel, QPushButton, QSplitter, QScrollArea,
    QFrame, QGroupBox, QTreeWidget, QTreeWidgetItem,
    QTreeWidgetItemIterator  # BUG FIX: ÎàÑÎùΩÎêú ÌÅ¥ÎûòÏä§ import
)
from PySide6.QtCore import Qt, Signal
from PySide6.QtGui import QFont, QTextCharFormat, QTextCursor, QColor
import os
from datetime import datetime

from core.models import FileStatus, Version, FileDiff, FileChangeType


class FileTreeWidget(QTreeWidget):
    """ÌååÏùº Ìä∏Î¶¨ ÏúÑÏ†Ø (Ìè¥Îçî Íµ¨Ï°∞ ÌëúÏãú)"""
    
    file_double_clicked = Signal(str)
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setHeaderLabels(["ÌååÏùº/Ìè¥Îçî", "ÏÉÅÌÉú"])
        self.setMinimumWidth(350)
        self.itemDoubleClicked.connect(self._on_item_double_clicked)
        self.setColumnWidth(0, 220)
        self.setColumnWidth(1, 100)
        
    def update_files(self, file_statuses: List[FileStatus]):
        self.clear()
        if not file_statuses:
            return
        
        folder_items: Dict[str, QTreeWidgetItem] = {}
        for status in sorted(file_statuses, key=lambda s: s.path):
            path_parts = os.path.normpath(status.path).split(os.sep)
            current_parent = self.invisibleRootItem()
            current_path = ""

            for i, part in enumerate(path_parts[:-1]):
                current_path = os.path.join(current_path, part)
                if current_path not in folder_items:
                    folder_item = QTreeWidgetItem(current_parent, [f"üìÅ {part}", ""])
                    folder_items[current_path] = folder_item
                current_parent = folder_items[current_path]
            
            file_item = self._create_file_item(status)
            current_parent.addChild(file_item)

        self._update_folder_status()
    
    def _create_file_item(self, status: FileStatus) -> QTreeWidgetItem:
        file_name = os.path.basename(status.path)
        icon = self._get_status_icon(status.change_type)
        status_text = self._get_status_text(status.change_type)
        
        item = QTreeWidgetItem([f"{icon} {file_name}", status_text])
        item.setData(0, Qt.UserRole, status)
        
        if status.change_type == FileChangeType.DELETED:
            item.setForeground(0, QColor(200, 0, 0))
            item.setForeground(1, QColor(200, 0, 0))
        elif status.change_type == FileChangeType.ADDED:
            item.setForeground(0, QColor(0, 150, 0))
            item.setForeground(1, QColor(0, 150, 0))
        elif status.change_type == FileChangeType.MODIFIED:
            item.setForeground(0, QColor(200, 120, 0))
            item.setForeground(1, QColor(200, 120, 0))
        
        tooltip_lines = [
            f"Í≤ΩÎ°ú: {status.path}",
            f"ÌÅ¨Í∏∞: {status.size_display}",
            f"ÏàòÏ†ïÏãúÍ∞Ñ: {status.last_modified.strftime('%Y-%m-%d %H:%M:%S') if status.last_modified != datetime.min else 'Ïïå Ïàò ÏóÜÏùå'}"
        ]
        item.setToolTip(0, "\n".join(tooltip_lines))
        
        return item
        
    def _get_status_icon(self, change_type: FileChangeType) -> str:
        return {
            FileChangeType.UNCHANGED: "üìÑ",
            FileChangeType.MODIFIED: "üìù",
            FileChangeType.ADDED: "‚ú®",
            FileChangeType.DELETED: "‚ùå"
        }.get(change_type, "‚ùì")
    
    def _get_status_text(self, change_type: FileChangeType) -> str:
        return {
            FileChangeType.UNCHANGED: "Ï†ïÏÉÅ",
            FileChangeType.MODIFIED: "ÏàòÏ†ïÎê®",
            FileChangeType.ADDED: "Ï∂îÍ∞ÄÎê®",
            FileChangeType.DELETED: "ÏÇ≠Ï†úÎê®"
        }.get(change_type, "")
    
    def _update_folder_status(self):
        iterator = QTreeWidgetItemIterator(self)
        while iterator.value():
            item = iterator.value()
            if item.childCount() > 0:
                changed_count = 0
                for i in range(item.childCount()):
                    child = item.child(i)
                    if child.data(0, Qt.UserRole):
                        status = child.data(0, Qt.UserRole)
                        if status.change_type != FileChangeType.UNCHANGED:
                            changed_count += 1
                if changed_count > 0:
                    item.setText(1, f"{changed_count}Í∞ú Î≥ÄÍ≤Ω")
                    item.setExpanded(True)
            iterator += 1

    def _on_item_double_clicked(self, item: QTreeWidgetItem, column: int):
        status = item.data(0, Qt.UserRole)
        if status:
            self.file_double_clicked.emit(status.path)
    
    def get_selected_file_status(self) -> Optional[FileStatus]:
        current_item = self.currentItem()
        if current_item and current_item.data(0, Qt.UserRole):
            return current_item.data(0, Qt.UserRole)
        return None

# ... Ïù¥Ìïò ÏΩîÎìú ÎèôÏùº ...
class VersionHistoryWidget(QListWidget):
    """Î≤ÑÏ†Ñ ÌûàÏä§ÌÜ†Î¶¨ ÏúÑÏ†Ø (Ïò§Î•∏Ï™Ω Ìå®ÎÑê)"""
    
    version_double_clicked = Signal(int)
    version_selection_changed = Signal(Version) # Version Í∞ùÏ≤¥Î•º Ï†ÑÎã¨ÌïòÎäî ÏÉà ÏãúÍ∑∏ÎÑê

    def __init__(self, parent=None):
        super().__init__(parent)
        self.setMinimumWidth(350)
        self.itemDoubleClicked.connect(self._on_item_double_clicked)
        self.currentItemChanged.connect(self._on_current_item_changed) # ÏÑ†ÌÉù Î≥ÄÍ≤Ω ÏãúÍ∑∏ÎÑê
        
    def update_versions(self, versions: List[Version], current_version: int):
        self.blockSignals(True) # ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïã†Ìò∏ Î∞úÏÉù Î∞©ÏßÄ
        self.clear()
        
        selected_item = None
        for version in reversed(versions):
            item = QListWidgetItem()
            current_indicator = "üìç " if version.number == current_version else ""
            
            # --- NEW: ÏûêÎèô Î°úÍ∑∏ ÏöîÏïΩ Ï†ïÎ≥¥ ÌëúÏãú ---
            log_summary = version.auto_log_summary
            
            text = f"{current_indicator}v{version.number} - {version.description_short} {log_summary}\n"
            text += f"üìÖ {version.created_at_display}\n"
            text += f"üìÑ ÌååÏùº {len(version.files)}Í∞ú"
            
            item.setText(text)
            item.setData(Qt.UserRole, version)
            
            if version.number == current_version:
                item.setBackground(QColor(230, 240, 255))
                font = item.font()
                font.setBold(True)
                item.setFont(font)
                selected_item = item
            
            tooltip_lines = [f"Î≤ÑÏ†Ñ: v{version.number}", f"ÏÑ§Î™Ö: {version.description}", f"ÏÉùÏÑ±Ïùº: {version.created_at_display}", f"Ìè¨Ìï®Îêú ÌååÏùº: {len(version.files)}Í∞ú"]
            item.setToolTip("\n".join(tooltip_lines))
            self.addItem(item)
            
        if selected_item:
            self.setCurrentItem(selected_item)
            
        self.blockSignals(False) # Ïã†Ìò∏ Î∞úÏÉù Ïû¨Í∞ú
        # ÏàòÎèôÏúºÎ°ú Ï≤´ ÏÑ†ÌÉù ÏïÑÏù¥ÌÖúÏóê ÎåÄÌïú Ïã†Ìò∏ Î∞úÏÉù
        if self.currentItem():
            self._on_current_item_changed(self.currentItem(), None)
    
    def _on_current_item_changed(self, current: QListWidgetItem, previous: QListWidgetItem):
        """ÏÑ†ÌÉùÎêú ÏïÑÏù¥ÌÖúÏù¥ Î≥ÄÍ≤ΩÎê† Îïå Ïã†Ìò∏Î•º Î≥¥ÎÉÖÎãàÎã§."""
        if current:
            version = current.data(Qt.UserRole)
            if version:
                self.version_selection_changed.emit(version)
                
    def _on_item_double_clicked(self, item: QListWidgetItem):
        version = item.data(Qt.UserRole)
        if version:
            self.version_double_clicked.emit(version.number)
    
    def get_selected_version(self) -> Optional[Version]:
        current_item = self.currentItem()
        if current_item:
            return current_item.data(Qt.UserRole)
        return None


class DiffViewerWidget(QWidget):
    """Diff Î∑∞Ïñ¥ ÏúÑÏ†Ø"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setup_ui()
    
    def setup_ui(self):
        layout = QVBoxLayout(self)
        self.header_label = QLabel()
        self.header_label.setStyleSheet("QLabel { font-weight: bold; padding: 8px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 3px; }")
        layout.addWidget(self.header_label)
        self.diff_text = QTextEdit()
        self.diff_text.setReadOnly(True)
        self.diff_text.setFont(QFont("Consolas", 9))
        layout.addWidget(self.diff_text)
        self.stats_label = QLabel()
        self.stats_label.setStyleSheet("QLabel { padding: 4px; background-color: #f8f8f8; border: 1px solid #ddd; font-size: 11px; }")
        layout.addWidget(self.stats_label)
    
    def show_diff(self, diff: FileDiff):
        if not diff.is_text_file:
            self.show_binary_file_diff(diff)
            return
        
        if diff.new_version == -1:
            header = f"v{diff.old_version} ‚Üî current: {diff.file_path}"
        else:
            header = f"v{diff.old_version} ‚Üî v{diff.new_version}: {diff.file_path}"
        self.header_label.setText(header)
        
        if not diff.has_changes:
            self.diff_text.setPlainText("Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÏóÜÏùå")
            self.stats_label.setText("")
            return
        
        self.diff_text.clear()
        cursor = self.diff_text.textCursor()
        added_format = QTextCharFormat(); added_format.setBackground(QColor(230, 255, 230))
        removed_format = QTextCharFormat(); removed_format.setBackground(QColor(255, 230, 230))
        context_format = QTextCharFormat(); context_format.setForeground(QColor(128, 128, 128))
        normal_format = QTextCharFormat()
        
        for change_type, content in diff.diff_lines:
            if change_type == "added":
                cursor.setCharFormat(added_format); cursor.insertText(f"+ {content}\n")
            elif change_type == "removed":
                cursor.setCharFormat(removed_format); cursor.insertText(f"- {content}\n")
            elif change_type == "context":
                cursor.setCharFormat(context_format); cursor.insertText(f"{content}\n")
            else:
                cursor.setCharFormat(normal_format); cursor.insertText(f"  {content}\n")
        self.show_diff_stats(diff)
    
    def show_binary_file_diff(self, diff: FileDiff):
        self.header_label.setText(f"{diff.file_path} (Î∞îÏù¥ÎÑàÎ¶¨ ÌååÏùº)")
        self.diff_text.setPlainText(f"Î∞îÏù¥ÎÑàÎ¶¨ ÌååÏùº: {diff.change_summary}")
        self.stats_label.setText("")
    
    def show_diff_stats(self, diff: FileDiff):
        added_lines = sum(1 for change_type, _ in diff.diff_lines if change_type == "added")
        removed_lines = sum(1 for change_type, _ in diff.diff_lines if change_type == "removed")
        self.stats_label.setText(f"Ï∂îÍ∞Ä: +{added_lines}Ï§Ñ, Ï†úÍ±∞: -{removed_lines}Ï§Ñ")
    
    def clear_diff(self):
        self.header_label.setText("ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏó¨ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî")
        self.diff_text.clear()
        self.stats_label.setText("")


class SearchResultWidget(QTreeWidget):
    """Í≤ÄÏÉâ Í≤∞Í≥º ÏúÑÏ†Ø"""
    
    result_double_clicked = Signal(dict)
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setup_ui()
    
    def setup_ui(self):
        self.setHeaderLabels(["Í≤ÄÏÉâ Í≤∞Í≥º", "Î≤ÑÏ†Ñ", "ÌååÏùº", "ÎùºÏù∏"])
        self.setRootIsDecorated(True)
        self.itemDoubleClicked.connect(self._on_item_double_clicked)
        self.setColumnWidth(0, 300); self.setColumnWidth(1, 60); self.setColumnWidth(2, 150); self.setColumnWidth(3, 60)
    
    def show_search_results(self, results: List[dict], query: str):
        self.clear()
        if not results:
            self.addTopLevelItem(QTreeWidgetItem(["Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå", "", "", ""]))
            return
        
        file_groups = {}
        for result in results:
            file_path = result["file_path"]
            if file_path not in file_groups: file_groups[file_path] = []
            file_groups[file_path].append(result)
        
        for file_path, file_results in file_groups.items():
            file_item = QTreeWidgetItem([f"üìÑ {file_path}", "", "", f"({len(file_results)}Í∞ú)"])
            file_item.setExpanded(True)
            for result in file_results:
                line_content = result["line_content"].strip()
                highlighted_content = line_content.replace(query, f"**{query}**")
                result_item = QTreeWidgetItem([highlighted_content, f"v{result['version'].number}", "", str(result["line_number"])])
                result_item.setData(0, Qt.UserRole, result)
                file_item.addChild(result_item)
            self.addTopLevelItem(file_item)
    
    def _on_item_double_clicked(self, item: QTreeWidgetItem, column: int):
        result_data = item.data(0, Qt.UserRole)
        if result_data:
            self.result_double_clicked.emit(result_data)


class ProjectInfoWidget(QWidget):
    """ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ ÌëúÏãú ÏúÑÏ†Ø"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setup_ui()
    
    def setup_ui(self):
        layout = QVBoxLayout(self)
        info_group = QGroupBox("ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥"); info_layout = QVBoxLayout(info_group)
        self.name_label = QLabel(); self.description_label = QLabel(); self.created_label = QLabel()
        self.version_label = QLabel(); self.files_label = QLabel()
        info_layout.addWidget(self.name_label); info_layout.addWidget(self.description_label); info_layout.addWidget(self.created_label)
        info_layout.addWidget(self.version_label); info_layout.addWidget(self.files_label); layout.addWidget(info_group)
        recent_group = QGroupBox("ÏµúÍ∑º Î≤ÑÏ†Ñ"); recent_layout = QVBoxLayout(recent_group)
        self.recent_versions_list = QListWidget(); self.recent_versions_list.setMaximumHeight(150); recent_layout.addWidget(self.recent_versions_list)
        layout.addWidget(recent_group); layout.addStretch()
    
    def update_project_info(self, project_data: Dict):
        settings = project_data.get("settings", {})
        self.name_label.setText(f"üìÅ Ïù¥Î¶Ñ: {settings.get('name', 'Unknown')}")
        self.description_label.setText(f"üìù ÏÑ§Î™Ö: {settings.get('description', 'ÏÑ§Î™Ö ÏóÜÏùå')}")
        self.created_label.setText(f"üìÖ ÏÉùÏÑ±Ïùº: {settings.get('created_at', 'Unknown')}")
        self.version_label.setText(f"üìã ÌòÑÏû¨ Î≤ÑÏ†Ñ: v{project_data.get('current_version', 0)}")
        self.files_label.setText(f"üìÑ Ï∂îÏ†Å ÌååÏùº: {project_data.get('tracked_files_count', 0)}Í∞ú")
        
        self.recent_versions_list.clear()
        versions = project_data.get("versions", [])
        for version_data in sorted(versions, key=lambda v: v["number"], reverse=True)[:5]:
            item_text = f"v{version_data['number']} - {version_data['description'][:30]}"
            if len(version_data['description']) > 30: item_text += "..."
            item = QListWidgetItem(item_text); item.setToolTip(version_data['description']); self.recent_versions_list.addItem(item)


class StatusBarWidget(QWidget):
    """ÏÉÅÌÉúÎ∞î ÏúÑÏ†Ø"""
    def __init__(self, parent=None):
        super().__init__(parent); self.setup_ui()
    def setup_ui(self):
        layout = QHBoxLayout(self); layout.setContentsMargins(8, 4, 8, 4)
        self.status_label = QLabel("Ï§ÄÎπÑ"); self.changed_files_label = QLabel(""); self.version_label = QLabel("")
        layout.addWidget(self.status_label); layout.addStretch(); layout.addWidget(self.changed_files_label)
        layout.addWidget(QLabel("|")); layout.addWidget(self.version_label)
    def update_status(self, status_text: str): self.status_label.setText(status_text)
    def update_changed_files(self, count: int):
        if count > 0:
            self.changed_files_label.setText(f"‚ö†Ô∏è Î≥ÄÍ≤ΩÎêú ÌååÏùº: {count}Í∞ú"); self.changed_files_label.setStyleSheet("color: orange; font-weight: bold;")
        else:
            self.changed_files_label.setText("‚úÖ Î™®Îì† ÌååÏùº ÏµúÏã† ÏÉÅÌÉú"); self.changed_files_label.setStyleSheet("color: green;")
    def update_version(self, current_version: int, total_versions: int):
        self.version_label.setText(f"v{current_version} (Ï¥ù {total_versions}Í∞ú)")